<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sweep Data Reviewer</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; color: #222; }
  #drop-zone { display: flex; align-items: center; justify-content: center; height: 100vh;
    border: 3px dashed #aaa; margin: 20px; border-radius: 12px; font-size: 1.2em; color: #888; }
  #drop-zone.dragover { border-color: #4a9eff; background: #eef5ff; }
  #app { display: none; max-width: 900px; margin: 0 auto; padding: 16px; }
  /* Filters */
  .filters { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: #fff;
    border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.1); align-items: center; }
  .filters select, .filters input { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: .85em; }
  .filters label { font-size: .8em; color: #666; margin-right: 2px; }
  .filter-group { display: flex; align-items: center; gap: 3px; }
  /* Nav */
  .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .nav button { padding: 6px 16px; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; }
  .nav button:hover { background: #eee; }
  .nav button:disabled { opacity: .4; cursor: default; }
  .nav .counter { font-size: .9em; color: #555; }
  /* Card */
  .card { background: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
  .card-header { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: .75em; font-weight: 600; }
  .tag-pass { background: #d4edda; color: #155724; }
  .tag-fail { background: #f8d7da; color: #721c24; }
  .tag-inj { background: #cce5ff; color: #004085; }
  .tag-ctrl { background: #e2e3e5; color: #383d41; }
  .tag-incoh { background: #fff3cd; color: #856404; }
  .tag-model { background: #e8daef; color: #4a235a; }
  .meta { font-size: .8em; color: #777; margin-bottom: 8px; }
  .response-label { font-size: .75em; font-weight: 600; color: #999; text-transform: uppercase; margin-bottom: 4px; }
  .response { white-space: pre-wrap; font-family: 'SF Mono', 'Menlo', monospace; font-size: .85em;
    background: #fafafa; padding: 12px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 12px;
    max-height: 300px; overflow-y: auto; line-height: 1.5; }
  .judge-section { background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 12px; }
  .judge-section .response-label { margin-bottom: 6px; }
  .judge-reasoning { font-size: .85em; line-height: 1.4; }
  /* Comment */
  .comment-section { margin-top: 10px; }
  .comment-section textarea { width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd;
    border-radius: 6px; font-family: inherit; font-size: .85em; resize: vertical; }
  .comment-section textarea:focus { outline: none; border-color: #4a9eff; }
  /* Toolbar */
  .toolbar { display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end; }
  .toolbar button { padding: 6px 14px; border: 1px solid #ccc; border-radius: 4px; background: #fff;
    cursor: pointer; font-size: .85em; }
  .toolbar button:hover { background: #eee; }
  .toolbar .btn-primary { background: #4a9eff; color: #fff; border-color: #4a9eff; }
  .toolbar .btn-primary:hover { background: #3a8eef; }
  .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff;
    padding: 10px 20px; border-radius: 6px; font-size: .9em; opacity: 0; transition: opacity .3s; }
  .toast.show { opacity: 1; }
  .stats { font-size: .8em; color: #666; padding: 8px 12px; background: #fff; border-radius: 8px;
    margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
  .commented-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    background: #f0ad4e; margin-left: 6px; vertical-align: middle; }
  .labeled-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    background: #5cb85c; margin-left: 6px; vertical-align: middle; }
  .refusal-badge { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: .7em;
    font-weight: 700; background: #d9534f; color: #fff; margin-left: 6px; vertical-align: middle;
    letter-spacing: .03em; }
  .id-text { font-size: .75em; color: #999; font-family: monospace; word-break: break-all; }
  .keyboard-hint { font-size: .75em; color: #aaa; }
  /* Label section */
  .label-section { background: #f0f7ff; padding: 12px; border-radius: 6px; border: 2px solid #b8d4f0;
    margin-bottom: 12px; }
  .label-section.has-label { border-color: #5cb85c; background: #f0f9f0; }
  .label-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 8px; }
  .label-field { display: flex; align-items: center; gap: 4px; }
  .label-field label { font-size: .8em; font-weight: 600; color: #555; }
  .label-field select, .label-field input[type="checkbox"] { font-size: .85em; }
  .label-reasoning { width: 100%; height: 50px; padding: 8px; border: 1px solid #ccd; border-radius: 4px;
    font-family: inherit; font-size: .85em; resize: vertical; margin-bottom: 8px; }
  .label-reasoning:focus { outline: none; border-color: #4a9eff; }
  .btn-save-label { padding: 6px 18px; border: none; border-radius: 4px; background: #5cb85c; color: #fff;
    cursor: pointer; font-size: .85em; font-weight: 600; }
  .btn-save-label:hover { background: #4cae4c; }
  .label-saved-msg { font-size: .8em; color: #5cb85c; font-weight: 600; margin-left: 8px; }
</style>
</head>
<body>

<div id="drop-zone">Drop a .jsonl file here to begin</div>

<div id="app">
  <div class="filters" id="filters"></div>
  <div class="stats" id="stats"></div>
  <div class="nav">
    <button id="prev-btn" onclick="go(-1)">&larr; Prev</button>
    <span class="counter" id="counter"></span>
    <span class="keyboard-hint">&larr; / &rarr; arrow keys</span>
    <button id="next-btn" onclick="go(1)">Next &rarr;</button>
  </div>
  <div class="card" id="card"></div>
  <div class="toolbar">
    <button onclick="jumpToCommented()">Next commented</button>
    <button onclick="jumpToUnlabeled()">Next commented w/o label</button>
    <button onclick="exportComments()">Copy comments</button>
    <button onclick="exportLabels()" class="btn-primary">Copy all labels (JSONL)</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let allData = [], filtered = [], idx = 0, comments = {}, labels = {};
const STORAGE_KEY = 'sweep-reviewer-comments';
const LABELS_KEY = 'sweep-reviewer-labels';

// Load from localStorage
try { comments = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e) {}
try { labels = JSON.parse(localStorage.getItem(LABELS_KEY) || '{}'); } catch(e) {}

function saveComments() { localStorage.setItem(STORAGE_KEY, JSON.stringify(comments)); }
function saveLabels() { localStorage.setItem(LABELS_KEY, JSON.stringify(labels)); }

// Drop zone
const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    allData = ev.target.result.trim().split('\n').map(l => JSON.parse(l));
    init();
  };
  reader.readAsText(file);
});

function extractModel(d) {
  const m = d.config?.model || '';
  const match = m.match(/(\d+\.?\d*B)/i);
  return match ? match[1] : m;
}

function init() {
  dz.style.display = 'none';
  document.getElementById('app').style.display = 'block';
  buildFilters();
  applyFilters();
}

function buildFilters() {
  const vals = (key, fn) => [...new Set(allData.map(fn || (d => d[key])))].sort();
  const models = [...new Set(allData.map(extractModel))].sort((a,b) => {
    const na = parseFloat(a), nb = parseFloat(b);
    return (isNaN(na) || isNaN(nb)) ? a.localeCompare(b) : na - nb;
  });
  const concepts = vals('concept', d => d.concept);
  const layers = [...new Set(allData.map(d => d.config?.layer))].sort((a,b) => a-b);
  const strengths = [...new Set(allData.map(d => d.config?.strength))].sort((a,b) => a-b);

  const html = [
    mkSelect('f-model', 'Model', ['All', ...models]),
    mkSelect('f-concept', 'Concept', ['All', ...concepts]),
    mkSelect('f-layer', 'Layer', ['All', ...layers]),
    mkSelect('f-strength', 'Strength', ['All', ...strengths]),
    mkSelect('f-injected', 'Trial', ['All', 'injection', 'control']),
    mkSelect('f-answer', 'Judge Answer', ['All', 'pass', 'fail']),
    mkSelect('f-coherent', 'Judge Coherent', ['All', 'true', 'false']),
    mkSelect('f-commented', 'Comments', ['All', 'has comment', 'no comment']),
    mkSelect('f-labeled', 'Label', ['All', 'labeled', 'unlabeled', 'commented+unlabeled']),
    mkSelect('f-label-refusal', 'Refusal', ['All', 'refusal=true', 'refusal=false']),
    mkSelect('f-label-coherent', 'Label Coherent', ['All', 'coherent=true', 'coherent=false']),
    `<div class="filter-group"><label>Search</label><input id="f-search" type="text" placeholder="text in response..." style="width:140px"></div>`,
  ].join('');
  document.getElementById('filters').innerHTML = html;

  document.querySelectorAll('.filters select, .filters input').forEach(el => {
    el.addEventListener('change', () => { idx = 0; applyFilters(); });
    if (el.tagName === 'INPUT') el.addEventListener('input', debounce(() => { idx = 0; applyFilters(); }, 300));
  });
}

function mkSelect(id, label, opts) {
  const options = opts.map(o => `<option value="${o}">${o}</option>`).join('');
  return `<div class="filter-group"><label>${label}</label><select id="${id}">${options}</select></div>`;
}

function gv(id) { return document.getElementById(id).value; }

function applyFilters() {
  const model = gv('f-model'), concept = gv('f-concept'), layer = gv('f-layer'),
        strength = gv('f-strength'), injected = gv('f-injected'), answer = gv('f-answer'),
        coherent = gv('f-coherent'), commented = gv('f-commented'), labeled = gv('f-labeled'),
        labelRefusal = gv('f-label-refusal'), labelCoherent = gv('f-label-coherent'),
        search = document.getElementById('f-search').value.toLowerCase();

  filtered = allData.filter(d => {
    if (model !== 'All' && extractModel(d) !== model) return false;
    if (concept !== 'All' && d.concept !== concept) return false;
    if (layer !== 'All' && String(d.config?.layer) !== layer) return false;
    if (strength !== 'All' && String(d.config?.strength) !== strength) return false;
    if (injected === 'injection' && !d.was_injected) return false;
    if (injected === 'control' && d.was_injected) return false;
    if (answer !== 'All' && d.judge?.answer !== answer) return false;
    if (coherent !== 'All' && String(d.judge?.coherent) !== coherent) return false;
    if (commented === 'has comment' && !comments[d.id]) return false;
    if (commented === 'no comment' && comments[d.id]) return false;
    if (labeled === 'labeled' && !labels[d.id]) return false;
    if (labeled === 'unlabeled' && labels[d.id]) return false;
    if (labeled === 'commented+unlabeled' && (!comments[d.id] || labels[d.id])) return false;
    // Refusal filter: filters based on label.refused stored in localStorage
    if (labelRefusal === 'refusal=true' && !labels[d.id]?.refused) return false;
    if (labelRefusal === 'refusal=false') {
      // Show records that either have no label or have label with refused !== true
      if (labels[d.id]?.refused === true) return false;
    }
    // Label coherent filter: filters based on label.coherent stored in localStorage
    if (labelCoherent === 'coherent=true') {
      if (!labels[d.id] || labels[d.id].coherent !== true) return false;
    }
    if (labelCoherent === 'coherent=false') {
      if (!labels[d.id] || labels[d.id].coherent !== false) return false;
    }
    if (search && !d.response?.toLowerCase().includes(search)) return false;
    return true;
  });

  if (idx >= filtered.length) idx = Math.max(0, filtered.length - 1);
  render();
}

function render() {
  const total = filtered.length;
  const commented_count = Object.keys(comments).filter(k => comments[k].trim()).length;
  const labeled_count = Object.keys(labels).length;
  const refusal_count = Object.values(labels).filter(lb => lb.refused).length;
  document.getElementById('stats').textContent =
    `${total} matched · ${labeled_count} labeled · ${refusal_count} refusals · ${commented_count} commented`;
  document.getElementById('counter').textContent = total ? `${idx + 1} / ${total}` : 'No results';
  document.getElementById('prev-btn').disabled = idx <= 0;
  document.getElementById('next-btn').disabled = idx >= total - 1;

  if (!total) { document.getElementById('card').innerHTML = '<p style="color:#999;padding:20px">No records match filters.</p>'; return; }

  const d = filtered[idx];
  const hasComment = comments[d.id]?.trim();
  const hasLabel = !!labels[d.id];
  const isRefusal = !!labels[d.id]?.refused;
  // Defaults: use saved label if exists, else fall back to judge output
  const lb = labels[d.id] || {};
  const dAnswer = lb.answer || d.judge?.answer || 'fail';
  const dCoherent = lb.coherent !== undefined ? lb.coherent : (d.judge?.coherent !== undefined ? d.judge.coherent : true);
  const dRefusal = lb.refused || false;
  const dDetected = lb.detected_concept !== undefined ? lb.detected_concept : (d.judge?.detected_concept || 'none');
  const dReasoning = lb.reasoning !== undefined ? lb.reasoning : (d.judge?.reasoning || '');

  const conceptOpts = ['none','celebration','ocean','fear','silence','other'].map(c =>
    `<option value="${c}" ${dDetected === c ? 'selected' : ''}>${c}</option>`).join('');

  document.getElementById('card').innerHTML = `
    <div class="card-header">
      <span class="tag ${d.was_injected ? 'tag-inj' : 'tag-ctrl'}">${d.was_injected ? 'INJECTION' : 'CONTROL'}</span>
      <span class="tag ${d.judge?.answer === 'pass' ? 'tag-pass' : 'tag-fail'}">judge: ${d.judge?.answer?.toUpperCase() || '?'}</span>
      ${d.judge?.coherent === false ? '<span class="tag tag-incoh">INCOHERENT</span>' : ''}
      <span class="tag tag-model">${extractModel(d)}</span>
      ${d.judge?.detected_concept ? `<span class="tag" style="background:#e0f0e0;color:#2a5">${d.judge.detected_concept}</span>` : ''}
      ${hasLabel ? '<span class="labeled-indicator" title="Has label"></span>' : ''}
      ${isRefusal ? '<span class="refusal-badge" title="Marked as refusal">REFUSAL</span>' : ''}
      ${hasComment ? '<span class="commented-indicator" title="Has comment"></span>' : ''}
    </div>
    <div class="id-text">${d.id}</div>
    <div class="meta">Layer ${d.config?.layer} · Strength ${d.config?.strength} · Concept: <b>${d.concept}</b> · Trial ${d.config?.trial}</div>
    <div class="response-label">Response</div>
    <div class="response">${escHtml(d.response || '')}</div>
    <div class="judge-section">
      <div class="response-label">Judge reasoning</div>
      <div class="judge-reasoning">${escHtml(d.judge?.reasoning || 'N/A')}</div>
    </div>
    <div class="label-section ${hasLabel ? 'has-label' : ''}">
      <div class="response-label">Your label ${hasLabel ? '(saved)' : ''}</div>
      <div class="label-row">
        <div class="label-field">
          <label>Answer</label>
          <select id="lb-answer"><option value="pass" ${dAnswer==='pass'?'selected':''}>pass</option><option value="fail" ${dAnswer==='fail'?'selected':''}>fail</option></select>
        </div>
        <div class="label-field">
          <label>Coherent</label>
          <input type="checkbox" id="lb-coherent" ${dCoherent ? 'checked' : ''}>
        </div>
        <div class="label-field">
          <label>Refusal</label>
          <input type="checkbox" id="lb-refusal" ${dRefusal ? 'checked' : ''}>
        </div>
        <div class="label-field">
          <label>Detected</label>
          <select id="lb-detected">${conceptOpts}</select>
        </div>
      </div>
      <textarea class="label-reasoning" id="lb-reasoning" placeholder="Reasoning for your label...">${escHtml(dReasoning)}</textarea>
      <div style="display:flex;align-items:center;">
        <button class="btn-save-label" onclick="saveCurrentLabel()">Save Label</button>
        ${hasLabel ? '<span class="label-saved-msg">&#10003; Labeled</span>' : ''}
      </div>
    </div>
    <div class="comment-section">
      <div class="response-label">Comment (optional note)</div>
      <textarea id="comment-box" placeholder="Add a note about this record...">${escHtml(comments[d.id] || '')}</textarea>
    </div>`;

  document.getElementById('comment-box').addEventListener('input', e => {
    const v = e.target.value.trim();
    if (v) comments[d.id] = v; else delete comments[d.id];
    saveComments();
  });
}

function saveCurrentLabel() {
  const d = filtered[idx];
  if (!d) return;
  labels[d.id] = {
    answer: document.getElementById('lb-answer').value,
    coherent: document.getElementById('lb-coherent').checked,
    refused: document.getElementById('lb-refusal').checked,
    detected_concept: document.getElementById('lb-detected').value === 'none' ? null : document.getElementById('lb-detected').value,
    reasoning: document.getElementById('lb-reasoning').value.trim(),
  };
  saveLabels();
  render();
  toast('Label saved');
}

function go(dir) {
  idx = Math.max(0, Math.min(filtered.length - 1, idx + dir));
  render();
  window.scrollTo(0, 0);
}

function jumpToCommented() {
  for (let i = idx + 1; i < filtered.length; i++) {
    if (comments[filtered[i].id]?.trim()) { idx = i; render(); window.scrollTo(0, 0); return; }
  }
  for (let i = 0; i <= idx; i++) {
    if (comments[filtered[i].id]?.trim()) { idx = i; render(); window.scrollTo(0, 0); return; }
  }
  toast('No commented records in current filter');
}

function jumpToUnlabeled() {
  for (let i = idx + 1; i < filtered.length; i++) {
    if (comments[filtered[i].id]?.trim() && !labels[filtered[i].id]) { idx = i; render(); window.scrollTo(0, 0); return; }
  }
  for (let i = 0; i <= idx; i++) {
    if (comments[filtered[i].id]?.trim() && !labels[filtered[i].id]) { idx = i; render(); window.scrollTo(0, 0); return; }
  }
  toast('No commented+unlabeled records in current filter');
}

function exportLabels() {
  const entries = Object.entries(labels);
  if (!entries.length) { toast('No labels to export'); return; }

  const lookup = {};
  allData.forEach(d => { lookup[d.id] = d; });

  const lines = entries.map(([id, lb]) => {
    const d = lookup[id];
    if (!d) return null;
    return JSON.stringify({
      id: d.id,
      concept: d.concept,
      was_injected: d.was_injected,
      response: d.response,
      config: d.config,
      label: {
        answer: lb.answer,
        coherent: lb.coherent,
        refused: lb.refused || false,
        detected_concept: lb.detected_concept,
        reasoning: lb.reasoning,
        labeler: 'human',
        timestamp: new Date().toISOString(),
      },
      judge: d.judge,
      comment: comments[d.id] || null,
    });
  }).filter(Boolean);

  const text = lines.join('\n');
  navigator.clipboard.writeText(text).then(() => toast(`Copied ${lines.length} labeled records as JSONL`));
}

function exportComments() {
  const entries = Object.entries(comments).filter(([,v]) => v.trim());
  if (!entries.length) { toast('No comments to export'); return; }

  // Build lookup for quick access
  const lookup = {};
  allData.forEach(d => { lookup[d.id] = d; });

  const lines = entries.map(([id, comment]) => {
    const d = lookup[id];
    if (!d) return `## ${id}\n**Comment:** ${comment}`;
    return `## ${id}\n**${extractModel(d)}** · ${d.concept} · ${d.was_injected ? 'injection' : 'control'} · L${d.config?.layer} S${d.config?.strength} · judge=${d.judge?.answer}\n**Comment:** ${comment}`;
  });

  const text = `# Sweep Review Comments (${entries.length} records)\n\n${lines.join('\n\n')}`;
  navigator.clipboard.writeText(text).then(() => toast(`Copied ${entries.length} comments to clipboard`));
}

function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg) {
  const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}
function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

// Keyboard nav
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
  if (e.key === 'ArrowLeft') go(-1);
  if (e.key === 'ArrowRight') go(1);
});
</script>
</body>
</html>
